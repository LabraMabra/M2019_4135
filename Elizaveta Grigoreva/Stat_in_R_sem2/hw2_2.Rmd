---
title: "hw_2.2 Elizaveta Grigoreva"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, warning=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(reshape2)
library(plyr)
library(car)
library(magrittr)
library(corrplot)
```
Load and clean dataset 
```{r}
aq <- read.csv2("/Users/Lisa/Downloads/AirQualityUCI/AirQualityUCI.csv", header=T)
aq_cleaned <-  aq  %>% select_if(~sum(!is.na(.)) > 0)  %>% drop_na()
airq_fil <- aq_cleaned %>% filter_all(all_vars(. != -200))
air_long <- melt(airq_fil)
head(air_long)
```
```{r}
ggplot(air_long, aes(value)) + 
  geom_histogram() + 
  facet_wrap(~variable, scales = "free")
```
```{r}
aq <- aq[,c(1:4,6:15)]
aq <- drop_na(aq)
air_long <- melt(aq)
air_long <- air_long[,-c(1,2)]
summary(aq)
```
Normalization
```{r}
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}
air_norm <- as.data.frame(lapply(aq[3:14], normalize))
air_long <- melt(air_norm)
head(air_norm)
```
Explore multicollinearity, choose good predictors.
I choose predictors based on the previous hw (that had linear deoendency)
```{r}
airq_fil %>%
  ggplot(aes(x= PT08.S4.NO2., y= C6H6.GT.)) +
  geom_point() +
  geom_smooth(method="lm")
```
```{r}
airq_fil  %>%
  lm(data= .,PT08.S4.NO2. ~ C6H6.GT.)%>%
  summary()
```
```{r}
airq_fil %>%
  ggplot(aes(x= PT08.S1.CO., y= C6H6.GT.)) +
  geom_point() +
  geom_smooth(method="lm")
```
```{r}
airq_fil  %>%
  lm(data= .,C6H6.GT. ~ PT08.S1.CO.)%>%
  summary()
```
We can check quantiles for this data
```{r}
qqnorm(air_norm$PT08.S4.NO2., pch = 1, frame = FALSE)
qqline(air_norm$PT08.S4.NO2., col = "steelblue", lwd = 2)
```
```{r}
qqnorm(air_norm$PT08.S1.CO., pch = 1, frame = FALSE)
qqline(air_norm$PT08.S1.CO., col = "steelblue", lwd = 2)
```
Check residuals for this predictors
```{r}
lm1 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO.)
summary(lm1)
```
```{r}
hist(residuals(lm1),main ="residuals PT08.S1.CO")
```
```{r}
plot(lm1,which=1)
```
```{r}
lm2 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S4.NO2.)
summary(lm2)
```
```{r}
hist(residuals(lm2),main ="residuals PT08.S4.NO2")
```
```{r}
plot(lm2,which=1)
```
Data is normaly distributed but we have some outliers. We can try to transform our predictors using x^2, log or sqrt and see what will improve plot
PT08.S1.CO sqrt
```{r}
air_norm$PT08.S1.CO_sq <- sqrt(air_norm$PT08.S1.CO.)
lm3 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO_sq + air_norm$PT08.S1.CO.)
hist(residuals(lm3),main ="PT08.S1.CO_sq")
```
```{r}
plot(lm3,which=1)
```
Check vif (vif >5: indicates multicollinearity)
```{r}
vif(lm3)
```
PT08.S1.CO  x^2
```{r}
air_norm$PT08.S1.CO_x2 <- (air_norm$PT08.S1.CO.)^2
lm4 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO_x2  + air_norm$PT08.S1.CO.)
hist(residuals(lm4),main ="PT08.S1.CO_x2")
```
```{r}
plot(lm4,which=1)
```
Check vif (vif >5: indicates multicollinearity) We can use x^2 transformation
```{r}
vif(lm4)
```
PT08.S1.CO  log(x)
```{r}
air_norm$PT08.S1.CO_log <- log(air_norm$PT08.S1.CO.)
air_norm$PT08.S1.CO_log[!is.finite(air_norm$PT08.S1.CO_log)] <- 0
lm5 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO_log  + air_norm$PT08.S1.CO.)
hist(residuals(lm5),main ="PT08.S1.CO_log")
```
```{r}
plot(lm5,which=1)
```
Look on vif
```{r}
vif(lm5)
```
We can choose x^2 transformed predictor based on vif
Let's look on the second one 
```{r}
air_norm$PT08.S4.N02_sq <- sqrt(air_norm$PT08.S4.NO2.)
lm6 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO_sq + air_norm$PT08.S4.NO2.)
hist(residuals(lm6),main ="PT08.S4.N02_sq ")
```
```{r}
plot(lm6,which=1)
```
Chieck vif
```{r}
vif(lm6)
```
PT08.S1.CO  x^2 (we cab use it)
```{r}
air_norm$PT08.S4.N02_x2 <- (air_norm$PT08.S4.NO2.)^2
lm7 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S4.N02_x2 + air_norm$PT08.S4.NO2.)
hist(residuals(lm7),main ="PT08.S4.N02_x2 ")
```
```{r}
plot(lm7,which=1)
```
Chieck vif
```{r}
vif(lm7)
```
PT08.S1.CO  log(x)
```{r}
air_norm$PT08.S4.N02_log <- log(air_norm$PT08.S4.NO2.)
air_norm$PT08.S4.N02_log[!is.finite(air_norm$PT08.S4.N02_log)] <- 0
lm8 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S4.N02_log + air_norm$PT08.S4.NO2.)
hist(residuals(lm9),main ="PT08.S4.N02_log ")
```
```{r}
plot(lm8,which=1)
```
Chieck vif
```{r}
vif(lm8)
```


```{r}
lm9 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO_x2 + air_norm$PT08.S4.N02_x2)
summary(lm9)
```
```{r}
residuals(lm9) %>% hist(main = "residuals multi regression PT08.S1.CO. + PT08.S4.NO2 predictors x^2 transfortmed")
```
```{r}
plot(lm9, which = 1)
```

vif < 5: 
Indicates that predictors are not redunant (not providing overlapping data to inform response)
```{r}
vif(lm9)
```

Bur R^2 better with not-transformed data
```{r}
lm10 <- lm(air_norm$C6H6.GT. ~ air_norm$PT08.S1.CO. + air_norm$PT08.S4.NO2.)
summary(lm10)
```
```{r}
residuals(lm10) %>% hist(main = "residuals multi regression PT08.S1.CO. + PT08.S4.NO2 predictors not transformed")
```

```{r}
plot(lm10, which = 1)
```
We have good model with few number of outliers, high R^2  and low vif




