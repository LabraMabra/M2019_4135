---
title: "Task 1"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(corrplot)
```

## Anscombe’s data set

• Scatter plot facetted by set

```{r}
data <- data.frame('x' = c(anscombe$x1, anscombe$x2, anscombe$x3, anscombe$x4), 
                   'y' = c(anscombe$y1, anscombe$y2, anscombe$y3, anscombe$y4),
                   'set' =  rep(c(1:4), each = 11))
ggplot(data, aes(x, y)) +
  geom_point() +
  facet_wrap(~ set)
```

• Summary calculation (mean, sd) grouped by set

```{r}
setNames(aggregate(data[, 1:2], list(data$set), mean), c('set', 'mean_x', 'mean_y'))

```

```{r}
setNames(aggregate(data[, 1:2], list('Sd' = data$set), sd),  c('set', 'sd_x', 'sd_y'))
```

• Pearson’s correlation by set, and non-parametric, and p-value

```{r message=FALSE, warning=FALSE}
data %>% group_by(set) %>% summarise(cor_pearson = cor.test(x,y, method = 'pearson')$estimate, 
                                      cor_kendall = cor.test(x,y, method = 'kendall')$estimate,
                                      cor_spearmen = cor.test(x,y, method = 'spearman')$estimate)
```

```{r message=FALSE, warning=FALSE}
data %>% group_by(set) %>% summarise(p_pearson = cor.test(x,y, method = 'pearson')$p.value,
                                     p_kendall = cor.test(x,y, method = 'kendall')$p.value,
                                     p_spearmen = cor.test(x,y, method = 'spearman')$p.value)

                                   
```

• Add geom_smooth() to the plot

```{r}
ggplot(data, aes(x, y)) +
  geom_point() + 
  geom_smooth(method = lm, se = FALSE) +
  facet_wrap(~ set) 
```

## Air Quality data set

```{r}
airq_data <- read.csv('/home/marina/Загрузки/AirQualityUCI.csv', sep = ';')
```

• Deleting NA columns and rows. Averaged concentration CO, Averaged Benzene concentration, Temperature, Humidity are factor columns in data, so it will be better to convert them into numeric. Actually, I don't need date and time for futher analysis, so I will slice the data.

```{r}
airq_data <- airq_data %>% select_if(~sum(!is.na(.)) > 0)  %>% drop_na()
airq_data[c('CO.GT.', 'C6H6.GT.', 'T', 'RH', 'AH')] <-  sapply(airq_data[c('CO.GT.', 'C6H6.GT.', 'T', 'RH', 'AH')], as.numeric)
airq_data <- airq_data[, c(3:15)]
```

• Exploring the variables (I make it in a 3 parts to better visualizing)

```{r}
ggplot(gather(airq_data[, c(1:4)], cols, value), aes(x = value)) + 
  geom_histogram(binwidth = 50) + facet_wrap(.~cols)
```

```{r}
ggplot(gather(airq_data[, c(5:8)], cols, value), aes(x = value)) + 
  geom_histogram(binwidth = 50) + facet_wrap(.~cols)

```

```{r}
ggplot(gather(airq_data[, c(9:13)], cols, value), aes(x = value)) + 
  geom_histogram(binwidth = 50) + facet_wrap(.~cols)
```

Ok, so it looks like a lot of variables have outliers and all of them in a different scale range
So, as for me,  it will be better to log-transform the data

• Log-transformation

```{r message=FALSE, warning=FALSE}
airq_data <- log10(airq_data) %>% drop_na()
```

So, let's look now as an example for the first 4 columns:

```{r}
ggplot(gather(airq_data[, c(1:4)], cols, value), aes(x = value)) + 
  geom_histogram(binwidth = 0.1) + facet_wrap(.~cols)
```

• Relationships between all variables

```{r}
pairs(airq_data)
```


```{r}
cor_data <- cor(airq_data)
corrplot(cor_data, method = 'circle')
```

We can see that  C6H6.GT. doesn't have a nice correlation with other variables.
An if we check the assumptions for each variable we will see, that mostly all of them are not adhered. 

Example:

```{r}
ggplot(airq_data, aes(x = CO.GT., y = C6H6.GT. )) + 
  geom_point() + 
  geom_smooth(method = 'lm')
```

```{r}
model_CO.GT. <- airq_data  %>%
   lm(data = .,  C6H6.GT. ~ CO.GT.)
residuals(model_CO.GT.) %>% hist()
```


```{r}
residuals(model_CO.GT.) %>% boxplot()
```


```{r}
plot(model_CO.GT., which = c(1,2))
```

So I decided to take a PT08.S3.NOx. as a predictor, because for me it seems a little bit better.
I checked the assumptions for each variable and took 3 best:

1) NOx.GT.

```{r}
ggplot(airq_data, aes(x = NOx.GT., y = PT08.S3.NOx. )) + 
  geom_point() + 
  geom_smooth(method = 'lm')
```

```{r}
model_NOx.GT. <- airq_data %>% lm(data = ., PT08.S3.NOx. ~ NOx.GT.)
residuals(model_NOx.GT.) %>% hist()
```


```{r}
residuals(model_NOx.GT.) %>% boxplot()
```


```{r}
plot(model_NOx.GT., which = c(1,2))
```

```{r}
summary(model_NOx.GT.)
```

Prediction:

```{r}
test_subset_NOx.GT. <-  airq_data[which(row.names(airq_data) %in% sample(row.names(airq_data), 25, replace = FALSE)), c(6,7)]
test_NOx.GT. <- data.frame(NOx.GT. = test_subset_NOx.GT.$NOx.GT.)
test_subset_NOx.GT.$pred_PT08.S3.NOx. <- predict(model_NOx.GT., newdata = test_NOx.GT.)
colnames(test_subset_NOx.GT.) <- c('real_NOx.GT.', 'real_PT08.S3.NOx.', 'pred_PT08.S3.NOx.')
head(test_subset_NOx.GT.)
```
      
```{r}
R <- round(summary(model_NOx.GT.)$adj.r.squared, digits = 4)
p <- round(summary(model_NOx.GT.)$coefficients[2,4], digits = 3)
titl <- paste('R^2 =', as.character(R),', p-val =', as.character(p))
ggplot() + 
  geom_point(data = airq_data, aes(NOx.GT., PT08.S3.NOx.)) + 
  geom_smooth(data = airq_data, aes(NOx.GT., PT08.S3.NOx.), method = 'lm') +
  geom_point(data = test_subset_NOx.GT., aes(real_NOx.GT., real_PT08.S3.NOx.), color = 'red') + 
  geom_point(data = test_subset_NOx.GT., aes(real_NOx.GT., pred_PT08.S3.NOx.), color = 'green') +
  labs(title = titl)
```


2) NMHC.GT.

```{r}
ggplot(airq_data, aes(x = NMHC.GT., y = PT08.S3.NOx.)) + 
  geom_point() + 
  geom_smooth(method = 'lm')
```

```{r}
model_NMHC.GT. <- airq_data %>%  lm(data = ., PT08.S3.NOx.~ NMHC.GT.)
residuals(model_NMHC.GT.) %>% hist()
```


```{r}
residuals(model_NMHC.GT.) %>% boxplot()
```


```{r}
plot(model_NMHC.GT., which = c(1,2))
```

Prediction:

```{r}
test_subset_NMHC.GT. <-  airq_data[which(row.names(airq_data) %in% sample(row.names(airq_data), 25, replace = FALSE)), c(3,7)]
test_NMHC.GT. <- data.frame(NMHC.GT. = test_subset_NMHC.GT.$NMHC.GT.)
test_subset_NMHC.GT.$pred_PT08.S3.NOx. <- predict(model_NMHC.GT., newdata = test_NMHC.GT.)
colnames(test_subset_NMHC.GT.) <- c('real_NMHC.GT.', 'real_PT08.S3.NOx.', 'pred_PT08.S3.NOx.')
head(test_subset_NMHC.GT.)
```
```{r}
R <- round(summary(model_NMHC.GT.)$adj.r.squared, digits = 3)
p <- round(summary(model_NMHC.GT.)$coefficients[2,4], digits = 3)
titl <- paste('R^2 =', as.character(R),', p-val =', as.character(p))
ggplot() + 
  geom_point(data = airq_data, aes(NMHC.GT., PT08.S3.NOx.)) + 
  geom_smooth(data = airq_data, aes(NMHC.GT., PT08.S3.NOx.), method = 'lm') +
  geom_point(data = test_subset_NMHC.GT., aes(real_NMHC.GT., real_PT08.S3.NOx.), color = 'red') + 
  geom_point(data = test_subset_NMHC.GT., aes(real_NMHC.GT., pred_PT08.S3.NOx.), color = 'green') +
  labs(title = titl)
```



3) PT08.S2.NMHC.

```{r}
ggplot(airq_data, aes(x = PT08.S2.NMHC., y = PT08.S3.NOx. )) + 
  geom_point() + 
  geom_smooth(method = 'lm')
```

```{r}
model_PT08.S2.NMHC. <- airq_data  %>% lm(data = .,  PT08.S3.NOx. ~ PT08.S2.NMHC.)
residuals(model_PT08.S2.NMHC.) %>% hist()
```


```{r}
residuals(model_PT08.S2.NMHC.) %>% boxplot()
```


```{r}
plot(model_PT08.S2.NMHC., which = c(1,2))
```

Prediction:

```{r}
test_subset_PT08.S2.NMHC. <-  airq_data[which(row.names(airq_data) %in% sample(row.names(airq_data), 25, replace = FALSE)), c(5,7)]
test_PT08.S2.NMHC. <- data.frame(PT08.S2.NMHC. = test_subset_PT08.S2.NMHC.$PT08.S2.NMHC.)
test_subset_PT08.S2.NMHC.$pred_PT08.S3.NOx. <- predict(model_PT08.S2.NMHC., newdata = test_PT08.S2.NMHC.)
colnames(test_subset_PT08.S2.NMHC.) <- c('real_PT08.S2.NMHC.', 'real_PT08.S3.NOx.', 'pred_PT08.S3.NOx.')
head(test_subset_PT08.S2.NMHC.)
```

```{r}
R <- round(summary(model_PT08.S2.NMHC.)$adj.r.squared, digits = 3)
p <- round(summary(model_PT08.S2.NMHC.)$coefficients[2,4], digits = 3)
titl <- paste('R^2 =', as.character(R),', p-val =', as.character(p))
ggplot() + 
  geom_point(data = airq_data, aes(PT08.S2.NMHC., PT08.S3.NOx.)) + 
  geom_smooth(data = airq_data, aes(PT08.S2.NMHC., PT08.S3.NOx.), method = 'lm') +
  geom_point(data = test_subset_PT08.S2.NMHC., aes(real_PT08.S2.NMHC., real_PT08.S3.NOx.), color = 'red') + 
  geom_point(data = test_subset_PT08.S2.NMHC., aes(real_PT08.S2.NMHC., pred_PT08.S3.NOx.), color = 'green') +
  labs(title = titl)
```

